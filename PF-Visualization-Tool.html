<!DOCTYPE html>
<html lang="zh-CN" style="height: 100%">
  <head>
    <meta charset="utf-8" />
    <title>Portfolio PF Visualization Tool</title>
    <style>
      #fileInfo {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        font-size: 20px;
      }
    </style>
  </head>

  <body style="height: 100%; margin: 0">
    <div style="position: absolute; top: 10px; left: 10px">
      <input type="file" id="fileInput" />
      <button id="playButton">Play</button>
      <button id="vsButton">VS.</button>
      <button id="lineButton">Line</button>
    </div>
    <div id="fileInfo" style="width: 100%; position: absolute; top: 40px"></div>
    <div
      id="container"
      style="height: 80%; width: 100%; margin-top: 60px"
    ></div>

    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"
    ></script>
    <script type="text/javascript">
      var dom = document.getElementById("container");
      var playButton = document.getElementById("playButton");
      var vsButton = document.getElementById("vsButton");
      var lineButton = document.getElementById("lineButton");
      var myChart = echarts.init(dom, null, {
        renderer: "canvas",
        useDirtyRect: false,
      });

      var playing = false;
      var vs = false;
      var line = true;
      var generationIndex = 0;
      var tmp_generationIndex = 0;
      var tmp_generationIndex2 = 0;
      var generationsInterval;
      var generations = [];
      var generations_2 = [];
      var max_generation = 0;
      var file_1 = "";
      var file_2 = "";
      var x_max = 0;
      var y_max = 0;

      var option = {
        xAxis: {
          min: 0,
          max: 250000,
          axisLabel: {
              interval: 'auto' // 根据自动计算的最佳间隔显示刻度标签
          },
          name: "Risk",
          nameLocation: "center",
          nameGap: 50,
          nameTextStyle: {
            fontSize: 16,
          },
          axisLabel: {
            margin: 10,
            align: "center",
          },
          axisLine: {
            lineStyle: {
              color: "black",
            },
          },
        },
        yAxis: {
          min: 0,
          max: 100000,
          axisLabel: {
              interval: 'auto' // 根据自动计算的最佳间隔显示刻度标签
          },
          name: "Return",
          nameLocation: "center",
          nameGap: 50,
          nameTextStyle: {
            fontSize: 16,
          },
          axisLabel: {
            margin: 10,
            align: "center",
            rotate: 90,
          },
          axisLine: {
            lineStyle: {
              color: "black",
            },
          },
        },
        series: [],
        graphic: [
          {
            type: "text",
            left: "center", // 文字水平居中
            top: 20, // 距离底部的距离
            style: {
              text: "Generation: " + 0, // 要显示的文字内容
              fill: "#666", // 文字颜色
              fontSize: 18, // 文字大小
            },
          },
        ],
      };
      // 圖檔相關
      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          var file = e.target.files[0];
          var reader = new FileReader();
          var fileInfo = document.getElementById("fileInfo");

          // 清空先前的数据
          option.series = []; // 清空 series
          myChart.clear();
          myChart.setOption(option); // 更新图表

          reader.onload = function (event) {
            var content = event.target.result;
            var lines = content
              .split("\n")
              .filter((line) => line.trim() !== "");
            var fileName = file.name;

            if (!vs) {
              generations = [];
              generations_2 = [];
              file_1 = fileName;
              file_2 = "";
              fileInfo.innerText = "Selected file: " + file_1;
              x_max = 0;
              y_max = 0;
            } else {
              generations_2 = [];
              file_2 = fileName;
              fileInfo.innerText =
                "Selected file: (Blue) " + file_1 + " vs. (Red) " + file_2;
            }
            generationIndex = 0;

            lines.forEach(function (line) {
              var data = line.trim().split(" ");
              var generation = data[0].substring(1);
              var portfolios = data.slice(1);
              var generationData = [];

              portfolios.forEach(function (portfolio) {
                var info = portfolio.split(",");
                var num_files = info[0];
                var stocks = info[1].split(";");
                var risk = info[2];
                var return_rate = info[3];
                var portfolioData = {
                  num_files: num_files,
                  stocks: stocks,
                  risk: risk,
                  return_rate: return_rate,
                };
                generationData.push(portfolioData);

                if (x_max < parseFloat(risk)) x_max = parseFloat(risk);
                if (y_max < parseFloat(return_rate)) y_max = parseFloat(return_rate);
              });

              // 对 generationData 按照 risk 从小到大排序
              generationData.sort(
                (a, b) => parseFloat(a.risk) - parseFloat(b.risk)
              );

              if (!vs) {
                generations.push(generationData);
              } else {
                generations_2.push(generationData);
              }
            });


            // 添加数据到 series (藍色 第一個方法的)
            var data = generations[generationIndex].map(function (item) {
              return [parseFloat(item.risk), parseFloat(item.return_rate)];
            });

            if (line) {
              option.series.push({
                type: "line",
                data: data,
                name: "Generation " + (generationIndex + 1),
                emphasis: {
                  focus: "series",
                },
                // 设置线条样式，采用HSL颜色模型，调整亮度
                lineStyle: {
                  color: 'blue',
                },
                // 设置点的样式，采用相同的HSL颜色模型，调整亮度
                itemStyle: {
                  color: 'blue',
                },
              });
            } else {
              option.series.push({
                type: "scatter",
                data: data,
                name: "Generation " + (generationIndex + 1),
                emphasis: {
                  focus: "series",
                },
                symbol: 'emptyCircle', // 设置散点图点的样式为空心圆形
                symbolSize: 4, // 设置空心圆形点的大小
                // 设置点的样式，采用相同的HSL颜色模型，调整亮度
                itemStyle: {
                  color: 'blue',
                },
              });
            }
            // 添加数据到 series (紅色 第二個方法的)
            if (vs) {
              var data = generations_2[generationIndex].map(function (item) {
                return [parseFloat(item.risk), parseFloat(item.return_rate)];
              });

              if (line) {
                option.series.push({
                  type: "line",
                  data: data,
                  name: "Generation " + (generationIndex + 1),
                  emphasis: {
                    focus: "series",
                  },
                  // 设置线条样式，采用HSL颜色模型，调整亮度
                  lineStyle: {
                    color: 'red', // 这里210是蓝色的色相，可以根据需要调整
                  },
                  // 设置点的样式，采用相同的HSL颜色模型，调整亮度
                  itemStyle: {
                    color: 'red',
                  },
                });
              } else {
                option.series.push({
                  type: "scatter",
                  data: data,
                  name: "Generation " + (generationIndex + 1),
                  emphasis: {
                    focus: "series",
                  },
                  symbol: 'emptyCircle', // 设置散点图点的样式为空心圆形
                  symbolSize: 4, // 设置空心圆形点的大小
                  // 设置点的样式，采用相同的HSL颜色模型，调整亮度
                  itemStyle: {
                    color: 'red',
                  },
                });
              }
            }
            // 輸出Generation的文字
            if (!vs) {
              option.graphic[0].style = {
                text: "Generation: " + (generationIndex + 1), // 要显示的文字内容
                fill: "#666", // 文字颜色
                fontSize: 18, // 文字大小
              };
              max_generation = generations.length;
              tmp_generationIndex = 0;
            } 
            else {
              option.graphic[0].style = {
                text:
                  "Generation: " +
                  (generationIndex + 1) +
                  " vs. " +
                  (generationIndex + 1), // 要显示的文字内容
                fill: "#666", // 文字颜色
                fontSize: 18, // 文字大小
              };

              if (generations.length > generations_2.length) {
                max_generation = generations.length;
              } else {
                max_generation = generations_2.length;
              }

              tmp_generationIndex = 0;
              tmp_generationIndex2 = 0;
            }

            x_max = Math.ceil(x_max / 1000) * 1000;
            y_max = Math.ceil(y_max / 1000) * 1000;

            var x_interval = (x_max - 0) / 5;
            var y_interval = (y_max - 0) / 5;

            // set xAxis
            option.xAxis = {
              min: 0,
              max: x_max,
              interval: x_interval, // 设置刻度标签的间隔
              name: "Risk",
              nameLocation: "center",
              nameGap: 50,
              nameTextStyle: {
                fontSize: 16,
              },
              axisLabel: {
                formatter: function (value, index) {
                    return parseFloat(value.toFixed(0)).toLocaleString(); // 格式化标签显示的内容为整数
                },
                margin: 10, // 设置刻度标签的边距
                align: "center" // 设置刻度标签水平居中对齐
              },
              axisLine: {
                lineStyle: {
                  color: "black",
                }
              },
            }
            // set yAxis
            option.yAxis = {
              min: 0,
              max: y_max,
              interval: y_interval, // 设置刻度标签的间隔
              name: "Return",
              nameLocation: "center",
              nameGap: 50,
              nameTextStyle: {
                fontSize: 16,
              },
              axisLabel: {
                formatter: function (value, index) {
                    return parseFloat(value.toFixed(0)).toLocaleString(); // 格式化标签显示的内容为整数
                },
                margin: 10, // 设置刻度标签的边距
                align: "center", // 设置刻度标签水平居中对齐
                rotate: 90,
              },
              axisLine: {
                lineStyle: {
                  color: "black",
                }
              },
            }

            myChart.setOption(option);
          };

          reader.readAsText(file);
        });

      // 初始保持空白坐标系
      myChart.setOption(option);

      window.addEventListener("resize", function () {
        myChart.resize();
      });

      playButton.addEventListener("click", function () {
        if (!playing) {
          playing = true;
          playButton.innerText = "Pause";
          generationsInterval = setInterval(drawNextGeneration, 700); // 设置每2秒绘制下一代
        } else {
          playing = false;
          playButton.innerText = "Play";
          clearInterval(generationsInterval); // 停止绘制
        }
      });

      vsButton.addEventListener("click", function () {
        if (!vs) {
          vs = true;
          vsButton.innerText = "VS. others";
        } else {
          vs = false;
          vsButton.innerText = "VS.";
        }
      });

      lineButton.addEventListener("click", function () {
        if (!line) {
          line = true;
          lineButton.innerText = "Line";
        } else {
          line = false;
          lineButton.innerText = "no Line";
        }
      });

      function drawNextGeneration() {
        generationIndex++;
        if (generationIndex < max_generation) {
          if (!vs) {
            option.series = []; // 清空 series
            if (generationIndex < generations.length) {
              var generation = generations[generationIndex];
              var data = generation.map(function (item) {
                return [parseFloat(item.risk), parseFloat(item.return_rate)];
              });

              if(line){
                option.series.push({
                  type: "line",
                  data: data,
                  name: "Generation " + (generationIndex + 1),
                  emphasis: {
                    focus: "series",
                  },
                  lineStyle: {
                    color: 'blue',
                  },
                  itemStyle: {
                    color: 'blue',
                  },
                });
              } else {
                option.series.push({
                  type: "scatter",
                  data: data,
                  name: "Generation " + (generationIndex + 1),
                  emphasis: {
                    focus: "series",
                  },
                  symbol: 'emptyCircle', // 设置散点图点的样式为空心圆形
                  symbolSize: 4, // 设置空心圆形点的大小
                  itemStyle: {
                    color: 'blue',
                  },
                });
              }
            }

            option.graphic[0].style = {
              text: "Generation: " + (generationIndex + 1), // 要显示的文字内容
              fill: "#666", // 文字颜色
              fontSize: 18, // 文字大小
            };
            tmp_generationIndex = generationIndex;
          } else {
            option.series = []; // 清空 series
            
            var g1 = generationIndex;
            var g2 = generationIndex;
            if (g1 + 1 > generations.length) g1 = generations.length - 1;
            if (g2 + 1 > generations_2.length) g2 = generations_2.length - 1;

            var generation = generations[g1];
            var data = generation.map(function (item) {
              return [parseFloat(item.risk), parseFloat(item.return_rate)];
            });

            if(line){
              option.series.push({
                type: "line",
                data: data,
                name: "Generation " + (g1 + 1),
                emphasis: {
                  focus: "series",
                },
                lineStyle: {
                  color: "blue",
                },
                itemStyle: {
                  color: "blue",
                },
              });
            } else {
              option.series.push({
                type: "scatter",
                data: data,
                name: "Generation " + (g1 + 1),
                emphasis: {
                  focus: "series",
                },
                symbol: 'emptyCircle', // 设置散点图点的样式为空心圆形
                symbolSize: 4, // 设置空心圆形点的大小
                itemStyle: {
                  color: "blue",
                },
              });
            }

            var generation = generations_2[g2];
            var data = generation.map(function (item) {
              return [parseFloat(item.risk), parseFloat(item.return_rate)];
            });

            if (line) {
              option.series.push({
                type: "line",
                data: data,
                name: "Generation " + (g2 + 1),
                emphasis: {
                  focus: "series",
                },
                lineStyle: {
                  color: "red",
                },
                itemStyle: {
                  color: "red",
                },
              });
            } else {
              option.series.push({
                type: "scatter",
                data: data,
                name: "Generation " + (g2 + 1),
                emphasis: {
                  focus: "series",
                },
                lineStyle: {
                  color: "red",
                },
                symbol: 'emptyCircle', // 设置散点图点的样式为空心圆形
                symbolSize: 4, // 设置空心圆形点的大小
                itemStyle: {
                  color: "red",
                },
              });
            }

            option.graphic[0].style = {
              text: "Generation: " + (g1 + 1) + " vs. " + (g2 + 1), // 要显示的文字内容
              fill: "#666", // 文字颜色
              fontSize: 18, // 文字大小
            };
            tmp_generationIndex = g1;
            tmp_generationIndex2 = g2;
          }

          myChart.setOption(option);
        } 
        else if (generationIndex == max_generation) {
          clearInterval(generationsInterval); // 所有代都已绘制完毕，停止绘制
          playing = false;
          playButton.innerText = "Play";
        } 
        else {
          generationIndex = -1;
        }
      }
      //還有bug，不確定怎麼看誰是0或是誰是1
      function handleMouseOver(params) {
        var dataIndex = params.dataIndex;
        var seriesIndex = params.seriesIndex;
        //console.log("dataIndex = " + dataIndex);
        //console.log("seriesIndex = " + seriesIndex);

        var generation;
        var fileInfo = document.getElementById("fileInfo");
        var popup = document.createElement("div");
        popup.id = "popup";
        popup.style.border = "1px solid black";
        popup.style.padding = "10px";

        // 检查使用哪个数组的数据
        if (seriesIndex == 0) {
            seriesIndex = tmp_generationIndex;
            //console.log(seriesIndex);
            generation = generations[seriesIndex][dataIndex];
            popup.innerHTML = `
                <p style="font-size: 12px">Generation: ${seriesIndex + 1}</p>
                <p style="font-size: 12px">Stocks Number: ${generation.num_files}</p>
                <p style="font-size: 12px">Stocks Infomation: ${generation.stocks.join(", ")}</p>
                <p style="font-size: 12px">Risk: ${generation.risk}</p>
                <p style="font-size: 12px">Return: ${generation.return_rate}</p>
            `;
        } else if (seriesIndex == 1) {
            seriesIndex = tmp_generationIndex2;
            //console.log(seriesIndex);
            generation = generations_2[seriesIndex][dataIndex];
            popup.innerHTML = `
                <p style="font-size: 12px">Generation: ${seriesIndex + 1}</p>
                <p style="font-size: 12px">Stocks Number: ${generation.num_files}</p>
                <p style="font-size: 12px">Stocks Infomation: ${generation.stocks.join(", ")}</p>
                <p style="font-size: 12px">Risk: ${generation.risk}</p>
                <p style="font-size: 12px">Return: ${generation.return_rate}</p>
            `;
        }
        document.body.appendChild(popup); // 将弹出框添加到 body 中，确保位于最上层

        // 获取鼠标指向的位置
        var mouseX = params.event.offsetX;
        var mouseY = params.event.offsetY;

        // 设置弹出框位置
        popup.style.position = "absolute";
        popup.style.left = mouseX + 10 + "px";
        popup.style.top = mouseY + 10 + "px"; // 向下偏移 10 像素
      }

      function handleMouseOut(params) {
        var fileInfo = document.getElementById("fileInfo");
        var popup = document.getElementById("popup");
        if (popup) {
            document.body.removeChild(popup); // 从 body 中移除弹出框
        }
      }

      // 鼠标悬停事件
      myChart.off("mouseover");
      myChart.on("mouseover", handleMouseOver);

      // 鼠标离开事件
      myChart.off("mouseout");
      myChart.on("mouseout", handleMouseOut);
    </script>
  </body>
</html>
